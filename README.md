# Positive Content Messenger + Protocol

## Протокол

### TL;DR: 
Подключение к серверу инициируется клиентом, клиент отправляет желаемый никнейм. При успехе дальнейшее общение происходит по цепочке "один клиент -> один сервер -> все клиенты". Для отправки сообщения от клиента серверу используется один формат сообщения, для отправки от сервера клиенту - другой, более полный (оба описаны ниже). Допустимо использование не более одного вложения с помощью конструкции att|PATH/TO/ATTACHMENT.xxx|. При получении ключевого слова "quit" или закрытии сокета клиентом сервер закрывает сокет соответствующего клиента. При завершении работы сервера все подключенные к нему клиенты отключаются. 

### Инициация соединения
- Клиент реализует подключение к серверу путём отправки сообщения, содержащего желаемый никнейм на серверный сокет с обозначенным портом (рекомендуемый порт: 5000). На каждое подобное сообщение сервер должен создать сокет для общения с клиентом.
--Никнейм состоит из любого сочетания букв и цифр, кроме никнейма "Server". 
--При попытке подключиться с некорректным никнеймом сервер должен отправить пользователю сообщение об использовании недопустимого никнейма и закрыть сокет.
--При попытке занять используемый никнейм сервер должен отправить пользователю сообщение о попытке использования занятого никнейма и закрыть сокет.
-- При успешном подключении сервер оповещает клиента об успехе сообщением, используя никнейм "Server".

### Отправка сообщения на сервер
- При отправке сообщения клиентом серверу используется следующий формат:
-- Сообщение не должно содержать специальных символов \n и \t.
-- Каждая строка должна быть отделена специальным символом переноса строки \n.
-- Поле msg не может быть пустым.
-- Поля attname и att могут быть либо одновременно пустыми, либо одновременно нести какую-либо информацию.
-- Строки с полями att и attname должны присутствовать в любом случае(если вложений нет, то пустые).
-- В поле attname указывается имя вложения с разрешением.
-- В поле att указывается размер вложения в байтах.
-- При наличии вложения, оно передается побайтово (количество байтов указано в поле att).
-- (n.b!) Не рекомендуется выводить пользователю сообщение, отправленное им же самим. Вместо этого нужно обработать это же сообщение, но уже пришедшее от сервера (гарантия того, что сообщение было принято сервером и разослано подключенным клиентам).
```
--- Общий формат: ---
msg: xxx
attname: yyy
att: zzz

--- Корректный пример с вложением: ---
msg: hey, here is attachment: att|attachment.png attached|.
attname: attachment.png
att: 55

--- Корректный пример без вложения: ---
msg: hey, no attachment here
attname: 
att: 

--- Некорректный пример №1: ---
msg: Sup, I am incorrect

--- Некорректный пример №2: ---
msg: 
attname: 
att: 
```

### Отправка сообщения сервером клиенту

- При отправке сообщения сервером клиенту используется следующий формат:
-- Время заполняется сервером автоматически, при получении сообщения от клиента. Время задаётся в формате ISO 8601: YYYY-MM-SSTHH:mm:ss
-- Время, указываемое сервером - UTC+0. На стороне клиента производится его преобразование под локальный часовой пояс. 
-- Никнейм заполняется сервером автоматически, исходя из того, от какого из приватных сокетов пришло сообщение.
-- Поле msg не должно быть пустым.
-- Поля attname и att могут быть либо одновременно пустыми, либо одновременно нести какую-либо информацию.
-- Строки с полями att и attname должны присутствовать в любом случае(если вложений нет, то пустые).
-- Сформированное сообщение рассылается всему списку подключенных клиентов.
```
--- Общий формат: ---
time: YYYY-MM-SSTHH:mm:ssZ
name: xxx
msg: yyy
attname: zzz
att: www

--- Корректный пример с вложением: ---
time: 2007-04-12T12:34:56Z
name: Frogge
msg: It is wednesday, my dudes! |frog.jpeg| attached
attname: frog.jpeg
att: 12

--- Корректный пример без вложения: ---
time: 2008-04-12T12:34:56Z
name: Yakuza
msg: It's friday night. Finally.
attname: 
att: 

--- Некорректный пример №1: ---
time: 2009-04-12T12:34:56Z
name: hackerman
msg: 
attname: 
att: 

--- Некорректный пример №2: ---
time: 2010-04-12T12:34:56Z
name: baka
msg: I'm sending msg to client in incorrect format!
```

### Разрыв соединения

- Инициация разрыва соединения клиентом происходит либо при введении слова "quit", либо при закрытии клиентом сокета (e.g. Закрытие клиентского приложения). В таких случаях сервер должен закрыть используемый для общения с данным клиентом сокет со своей стороны.
- Инициация разрыва соединения сервером происходит в двух вариантах:
-- Ошибка при подключении (e.g использование некорректного/занятого никнейма). Как описано выше, сервер отправляет сообщение об ошибке и закрывает сокет. В ответ на это клиент отображает сообщение об ошибке и закрывает сокет со своей стороны.
-- Окончание работы серверного приложения. В таком случае во всех активных подключениях сокеты автоматически закрываются с серверной стороны. В ответ на это клиент должен отобразить сообщение об ошибке и закрыть сокет со своей стороны.

### Сообщения об ошибках

Все сообщения об ошибках отправляются пользователю от имени "Server". Ниже представленны некоторые из них:
--Ошибка уникальности никнейма - ... [Server]: Sorry, this nickname is already taken. Choose another one.

## Positive Content Messenger

### TL;DR

Реализация клиента и сервера с использованием описанного выше протокола. Для выбора режима работы используется 
опция -t, которая может иметь значения "client" или "server". Для обоих режимов имеется возможность задать порт и 
адрес с использованием опций -p и -h соответственно. На порт вводятся ограничения диапазона [0 ; 65535], а host должен
быть в формате IPv4 (допускается использование localhost). При запуске в режиме "client" также требуется задать имя 
пользователя с использованием опции -n. На никнейм вводятся следующие ограничения:

-Запрещено использовать никнейм "Server" в любой комбинации регистров (используется в технических целях).
-Никнейм должен состоять только из символов и цифр (кириллица допускается).

В случае, если пользователь не указал имя с использованием опции, то от него потребуется ввод никнейма в командной 
строке. Если сервис запущен без опций, то выводится сообщение со всеми возможными опциями.
```
Usage: commands [OPTIONS]

Options for loading client:
-n, --nickname TEXT  User nickname for chat

Options:
-t, --type [client|server]  Choose to start server or client
-h, --host TEXT             Set host address
-p, --port INT              Set port
--help                      Show this message and exit

Process finished with exit code 0
```

Допускается не более чем одно вложение командой att|PATH/TO/FILE.xxx| в сообщении, при 
нахождении указанного в скобках пути вместо пути будет автоматически подставлено имя файла. Сохраняет полученные 
изображения в папке ./images .

### Сервер

- Сервер запускается с использованием флага [-t server]. По умолчанию он пытается создать публичный сокет на порту 5000.
-- Выдаёт сообщения в консоль при подключении/отключении клиента.
-- Вся реализация работы с вложениями (контроль расширений, проч.) должно быть реализовано на стороне клиента - сервер старается обрабатывать пользовательские данные минимально возможным образом.

### Клиент

- Клиент запускается с использованием [-t client -n nickname] (если никнейм не определен, потребуется ввод в 
  командной строке), где:
-- nickname - желаемый для использования никнейм.

### Общие параметры
- Запуск на другом порте и ip-адресе [-t (server/client) -h ip -p port]
-- ip - ip-адрес сервера в формате xxx.xxx.xxx.xxx.
-- port - порт, на котором запущен сервер по указанному ip-адресу.

- Клиент может:
-- Подключаться к серверу с попыткой занять заданный никнейм (при ошибке на данном этапе выдаёт сообщение об ошибке и заканчивает работу).
-- Отправлять сообщения (не пустые, однострочные - без использования \n)
-- Отправлять вложения при помощи att|PATH/TO/FILE.xxx|. Допустимо лишь одно вложение в одном сообщении, при успешном 
  нахождении файла по заданному пути путь подменяется на имя файла. При ненахождении сообщение отправляется в исходном виде. Клиент может отправить файлы, которые имеют MIME-типов "video" и "image".
-- Получать вложения. Все вложения (в том числе отправленные этим же клиентом) хранятся в папке ./images .
-- Закончить работу при помощи команды "quit" или просто закрыв приложение.